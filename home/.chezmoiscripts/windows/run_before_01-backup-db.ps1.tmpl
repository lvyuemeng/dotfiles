# Backup openlist database
$ErrorActionPreference = "Stop"

$chezmoiRoot  = "{{ .chezmoi.sourceDir }}"
$templPath = "$chezmoiRoot/.chezmoitemplates/openlist/data.db.age"

$dbPath   = "$HOME\scoop\persist\openlist\data\data.db"
$stateDir = "$HOME\.cache\openlist"
$hashFile = "$stateDir\data.db.sha256"

if (-not (Test-Path $dbPath)) {
    Write-Host "openlist db not found, skipping backup"
    exit 0
}

New-Item -ItemType Directory -Force -Path $stateDir | Out-Null
$currentHash = (Get-FileHash $dbPath -Algorithm SHA256).Hash

if (Test-Path $hashFile) {
    $previousHash = Get-Content $hashFile -Raw
    if ($previousHash -eq $currentHash) {
        Write-Host "OpenList DB unchanged, skipping backup" -ForegroundColor DarkGray
        exit 0
    }
}

chezmoi encrypt $dbPath > $templPath
$currentHash | Set-Content -NoNewline $hashFile
Write-Host "openlist db backed up" -ForegroundColor Green