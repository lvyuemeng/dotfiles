chezmoi:modify-template
{{- /* Load encrypted secrets */ -}}
{{- $secret := includeTemplate "data" . | fromToml -}}
{{- $v_api := $secret.virustotal.api_key -}}

{{- /* Parse existing config */ -}}
{{- $existing := dict -}}
{{- if .chezmoi.stdin }}
  {{- $existing = fromJson .chezmoi.stdin -}}
{{- end }}

{{- /* Merge desired state */ -}}
{{- $new := merge $existing (dict
    "scoop_repo" "https://gitee.com/scoop-installer/scoop"
    "scoop_branch" "master"
    "aria2-enabled" true
    "virustotal_api_key" $v_api
) -}}

{{- /* Remove ephemeral fields */ -}}
{{- $clean := omit $new "last_update" -}}

{{ $clean | toPrettyJson }}
